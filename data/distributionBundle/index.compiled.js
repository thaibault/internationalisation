'use strict';
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("clientnode")):"function"==typeof define&&define.amd?define("internationalisation",["clientnode"],t):"object"==typeof exports?exports.internationalisation=t(require("clientnode")):e.internationalisation=t(e.clientnode)}(this,function(e){return function(e){function t(o){if(n[o])return n[o].exports;var a=n[o]={exports:{},id:o,loaded:!1};return e[o].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.$=void 0;var r=function(){function e(e,t){var n=[],o=!0,a=!1,i=void 0;try{for(var r,s=e[Symbol.iterator]();!(o=(r=s.next()).done)&&(n.push(r.value),!t||n.length!==t);o=!0);}catch(l){a=!0,i=l}finally{try{!o&&s["return"]&&s["return"]()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),l=function d(e,t,n){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,t);if(void 0===o){var a=Object.getPrototypeOf(e);return null===a?void 0:d(a,t,n)}if("value"in o)return o.value;var i=o.get;if(void 0!==i)return i.call(n)},u=n(2),c=t.$=u.$,p=function(e){function t(){return o(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return i(t,e),s(t,[{key:"initialize",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments.length<=1||void 0===arguments[1]?"":arguments[1],o=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],a=arguments.length<=3||void 0===arguments[3]?null:arguments[3],i=this,r=arguments.length<=4||void 0===arguments[4]?[]:arguments[4],s=arguments.length<=5||void 0===arguments[5]?{}:arguments[5];this.currentLanguage=n,this.knownTranslation=o,this._$domNodeToFade=a,this._replacements=r,this._textNodesWithKnownTranslation=s,this._options={domNodeSelectorPrefix:"body","default":"enUS",selection:[],initial:null,templateDelimiter:{pre:"{{",post:"}}"},fadeEffect:!0,textNodeParent:{showAnimation:[{opacity:1},{duration:"fast"}],hideAnimation:[{opacity:0},{duration:"fast"}]},preReplacementLanguagePattern:"^\\|({1})$",replacementLanguagePattern:"^([a-z]{2}[A-Z]{2}):((.|\\s)*)$",currentLanguagePattern:"^[a-z]{2}[A-Z]{2}$",replacementDomNodeName:["#comment","langreplacement"],replaceDomNodeNames:["#text","langreplace"],toolsLockDescription:"{1}Switch",languageHashPrefix:"language-",currentLanguageIndicatorClassName:"current",sessionDescription:"{1}",languageMapping:{deDE:["de","de_de","de-de","german","deutsch"],enUS:["en","en_us","en-us"],enEN:["en_en","en-en","english"],frFR:["fr","fr_fr","fr-fr","french"]},onSwitched:this.constructor.noop,onEnsured:this.constructor.noop,onSwitch:this.constructor.noop,onEnsure:this.constructor.noop,domNode:{knownTranslation:"div.toc"}},l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"initialize",this).call(this,e),this._options.preReplacementLanguagePattern=this.constructor.stringFormat(this._options.preReplacementLanguagePattern,this._options.replacementLanguagePattern.substr(1,this._options.replacementLanguagePattern.length-2)),this._options.toolsLockDescription=this.constructor.stringFormat(this._options.toolsLockDescription,this.constructor._name),this._options.sessionDescription=this.constructor.stringFormat(this._options.sessionDescription,this.constructor._name),this.$domNodes=this.grabDomNode(this._options.domNode),this.$domNodes.switchLanguageButtons=c('a[href^="#'+this._options.languageHashPrefix+'"]'),this._movePreReplacementNodes(),this.currentLanguage=this._normalizeLanguage(this._options["default"]);var u=this._determineUsefulLanguage();return this.on(this.$domNodes.switchLanguageButtons,"click",function(e){return e.preventDefault(),i["switch"](c(e.target).attr("href").substr(i._options.languageHashPrefix.length+1))}),this.currentLanguage===u?c.when(this._switchCurrentLanguageIndicator(u)):this["switch"](u,!0)}},{key:"switch",value:function(e){var t=this,n=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];if(e!==!0&&this._options.selection.length&&!this._options.selection.includes(e))return this.debug('"{1}" isn\'t one of the allowed languages.',e),c.when(this);var o=c.Deferred();return this.acquireLock(this._options.toolsLockDescription,function(){if(e===!0?(n=!0,e=t.currentLanguage):e=t._normalizeLanguage(e),n&&e!==t._options["default"]||t.currentLanguage!==e){var a="Switch to";n&&(a="Ensure"),t.debug('{1} "{2}".',a,e),t._switchCurrentLanguageIndicator(e),t.fireEvent(n?"ensure":"switch",!0,t,t.currentLanguage,e),t._$domNodeToFade=null,t._replacements=[];var i=t._collectTextNodesToReplace(e,n),s=r(i,2),l=s[0],u=s[1];t._ensureLastTextNodeHavingLanguageIndicator(l,u,n),t._handleSwitchEffect(e,n).then(function(){return o.resolve(t)})}else t.debug('"{1}" is already current selected language.',e),t.releaseLock(t._options.toolsLockDescription),o.resolve(t)}),o}},{key:"refresh",value:function(){return this._movePreReplacementNodes()["switch"](!0)}},{key:"_movePreReplacementNodes",value:function(){var e=this;return this.$domNodes.parent.find(":not(iframe)").contents().each(function(){var t=c(this),n=t.prop("nodeName").toLowerCase();if(e._options.replacementDomNodeName.includes(n)){["#comment","#text"].includes(n)||t.hide();var o=new RegExp(e._options.preReplacementLanguagePattern),a=t.prop("textContent").match(o);a&&a[0]&&!function(){t.prop("textContent",t.prop("textContent").replace(o,a[1]));var e=!1;t.parent().contents().each(function(){return e&&c(this).Tools("getText").trim()?(t.appendTo(this),!1):void(t[0]===this&&(e=!0))})}()}}),this}},{key:"_collectTextNodesToReplace",value:function(e,t){var n=null,o=null,a=null,i=null;this.knownTranslation={};var r=this;return this.$domNodes.parent.find(":not(iframe)").contents().each(function(){var s=c(this),l=s.prop("nodeName").toLowerCase();if(r._options.replaceDomNodeNames.includes(l.toLowerCase()))s.Tools("getText").trim()&&0===s.parents(r._options.replaceDomNodeNames.join()).length&&(i=r._ensureLastTextNodeHavingLanguageIndicator(a,i,t),n=s);else if(n){if(r._options.replacementDomNodeName.includes(l)){var u=s.prop("textContent");"#comment"!==l&&(u=s.html());var p=u.match(new RegExp(r._options.replacementLanguagePattern));return Array.isArray(p)&&p[1]===e?(r.knownTranslation[n.Tools("getText").trim()]=p[2].trim(),r._registerTextNodeToChange(n,s,p,o),a=n,i=o,n=null,o=null):s.prop("textContent").match(new RegExp(r._options.currentLanguagePattern))&&(o=s),!0}a=null,i=null,n=null,o=null}}),this._registerKnownTextNodes(),[a,i]}},{key:"_registerKnownTextNodes",value:function(){this._textNodesWithKnownTranslation={};var e=this;return this.$domNodes.knownTranslation.find(":not(iframe)").contents().each(function(){var t=c(this);!e._options.replaceDomNodeNames.includes(t.prop("nodeName").toLowerCase())&&t.Tools("getText").trim()&&0===t.parents(e._options.replaceDomNodeNames.join()).length&&e.knownTranslation.hasOwnProperty(t.Tools("getText").trim())&&(e._addTextNodeToFade(t),e._textNodesWithKnownTranslation.hasOwnProperty(e.knownTranslation[t.prop("textContent").trim()])?e._textNodesWithKnownTranslation[e.knownTranslation[t.prop("textContent").trim()]]=e._textNodesWithKnownTranslation[e.knownTranslation[t.prop("textContent").trim()]].add(t):e._textNodesWithKnownTranslation[e.knownTranslation[t.prop("textContent").trim()]]=t)}),this}},{key:"_normalizeLanguage",value:function(e){for(var t in this._options.languageMapping)if(this._options.languageMapping.hasOwnProperty(t)&&(this._options.languageMapping[t].includes(t.toLowerCase())||this._options.languageMapping[t].push(t.toLowerCase()),this._options.languageMapping[t].includes(e.toLowerCase())))return t;return this._options["default"]}},{key:"_determineUsefulLanguage",value:function(){var e=void 0;return this._options.initial?e=this._options.initial:"localStorage"in c.global&&c.global.localStorage.getItem(this._options.sessionDescription)?(e=c.global.localStorage.getItem(this._options.sessionDescription),this.debug('Determine "{1}", because of local storage information.',e)):"navigator"in c.global&&c.global.navigator.language?(e=c.global.navigator.language,this.debug('Determine "{1}", because of browser settings.',e)):(e=this._options["default"],this.debug('Determine "{1}", because of default option.',e)),e=this._normalizeLanguage(e),this._options.selection.length&&!this._options.selection.includes(e)&&(this.debug('"{1}" isn\'t one of the allowed languages. Set language to "{2}".',e,this._options.selection[0]),e=this._options.selection[0]),"localStorage"in c.global&&c.global.localStorage.setItem(this._options.sessionDescription,e),e}},{key:"_handleSwitchEffect",value:function(e,t){var n=this,o=this.currentLanguage;return!t&&this._options.fadeEffect&&this._$domNodeToFade?this._$domNodeToFade.animate.apply(this._$domNodeToFade,this._options.textNodeParent.hideAnimation).promise().then(function(){return n._switchLanguage(e),n._$domNodeToFade?n._$domNodeToFade.animate.apply(n._$domNodeToFade,n._options.textNodeParent.showAnimation).promise().then(function(){return n.fireEvent(t?"ensured":"switched",!0,n,o,e),n.releaseLock(n._options.toolsLockDescription),c.when(n)}):c.when(n)}):(this._switchLanguage(e),this.fireEvent(t?"ensured":"switched",!0,this,o,e),this.releaseLock(this._options.toolsLockDescription),c.when(this))}},{key:"_addTextNodeToFade",value:function(e){var t=e.parent();return this._$domNodeToFade?this._$domNodeToFade=this._$domNodeToFade.add(t):this._$domNodeToFade=t,this}},{key:"_registerTextNodeToChange",value:function(e,t,n,o){return this._addTextNodeToFade(e),t&&this._replacements.push({$textNodeToTranslate:e,$nodeToReplace:t,textToReplace:n[2],$currentLanguageDomNode:o}),this}},{key:"_ensureLastTextNodeHavingLanguageIndicator",value:function(e,t,n){if(e&&!t){var o=this.currentLanguage;n&&(o=this._options["default"]),t=c("<!--"+o+"-->"),e.after(t)}return t}},{key:"_switchLanguage",value:function(e){var t=this,n=!0,o=!1,a=void 0;try{for(var i,r=function(){var n=i.value,o=n.$textNodeToTranslate.html();"#text"===n.$textNodeToTranslate.prop("nodeName")&&(o=n.$textNodeToTranslate.prop("textContent"));var a=o.trim();if(!t._options.templateDelimiter||!a.endsWith(t._options.templateDelimiter.post)&&t._options.templateDelimiter.post){var r=n.$currentLanguageDomNode;n.$currentLanguageDomNode||!function(){r=c("body");var e=!1;n.$textNodeToTranslate.parent().contents().each(function(){return e?(n.$currentLanguageDomNode=r=c(this),!1):void(this===n.$textNodeToTranslate[0]&&(e=!0))})}();var s=r.prop("textContent");e===s&&t.warn('Text node "'+n.textToReplace+'" is marked '+('as "'+s+'" and has same translation ')+"language as it already is.");var l=n.$nodeToReplace.prop("nodeName").toLowerCase();"#comment"===l?n.$textNodeToTranslate.after(c("<!--"+s+":"+o+"-->")):n.$textNodeToTranslate.after(c("<"+l+">"+s+":"+o+"</"+(l+">")).hide()),n.$textNodeToTranslate.after(c("<!--"+e+"-->")),"#text"===n.$textNodeToTranslate.prop("nodeName")?n.$textNodeToTranslate.prop("textContent",n.textToReplace):n.$textNodeToTranslate.html(n.textToReplace),r.remove(),n.$nodeToReplace.remove()}},s=this._replacements[Symbol.iterator]();!(n=(i=s.next()).done);n=!0)r()}catch(l){o=!0,a=l}finally{try{!n&&s["return"]&&s["return"]()}finally{if(o)throw a}}for(var u in this._textNodesWithKnownTranslation)this._textNodesWithKnownTranslation.hasOwnProperty(u)&&this._textNodesWithKnownTranslation[u].prop("textContent",u);return"localStorage"in c.global&&c.global.localStorage.setItem(this._options.sessionDescription,e),this.currentLanguage=e,this}},{key:"_switchCurrentLanguageIndicator",value:function(e){return c('a[href="#'+this._options.languageHashPrefix+(this.currentLanguage+'"].')+this._options.currentLanguageIndicatorClassName).removeClass(this._options.currentLanguageIndicatorClassName),c('a[href="#'+this._options.languageHashPrefix+e+'"]').addClass(this._options.currentLanguageIndicatorClassName),this}}]),t}(c.Tools["class"]);p._name="Language",t["default"]=p,c.Language=function(){return c.Tools().controller(p,arguments)},c.Language["class"]=p},function(t,n){t.exports=e}])});